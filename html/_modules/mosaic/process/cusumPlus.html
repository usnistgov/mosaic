<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>mosaic.process.cusumPlus &#8212; MOSAIC mweb2.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/style.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

	<script async type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagency=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>	

	<meta name="theme-color" content="#283593">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/icon_48.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b>mweb2.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../latex/MOSAIC.pdf">Download PDF</a></li>
                <li><a href="../../../doc/mailingList.html">Mailing List</a></li>
                <li><a href="//github.com/usnistgov/mosaic">Develop</a></li>
                <li><a href="//github.com/usnistgov/mosaic/issues">Issue Tracker</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/Algorithms.html">2. Data Processing Algorithms in <em>MOSAIC</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/GettingStarted.html">3. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/GraphicalInterface.html">4. <em>MOSAIC</em> GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/WebInterface.html">5. <em>MOSAIC</em> WEB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/settingsFile.html">6. Settings File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/DatabaseStructure.html">7. Database Structure and Query Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/ScriptingandAdvancedFeatures.html">8. Scripting and Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/Extend.html">9. Extend <em>MOSAIC</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/PublicationFigures.html">10. Publication Quality Figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/AdvancedAnalysis.html">11. Advanced Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/Addons.html">12. Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/DeveloperTools.html">13. Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/apidocs.html">14. API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/References.html">15. Bibliography</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for mosaic.process.cusumPlus</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Analyze a multi-step event with the CUSUM+ algorithm. Implements a modified version of the CUSUM algorithm </span>
<span class="sd">	(used by OpenNanopore for example) in MOSAIC. This approach sacrifices including system information in the </span>
<span class="sd">	analysis in favor of much faster fitting of single- and multi-level events.</span>

<span class="sd">	:Created:	2/10/2015</span>
<span class="sd">	:Author: 	Kyle Briggs &lt;kbrig035@uottawa.ca&gt;</span>
<span class="sd">	:License:	See LICENSE.TXT</span>
<span class="sd">	:ChangeLog:             </span>
<span class="sd">	.. line-block::</span>
<span class="sd">				11/15/19    JR  Updated output: calculates adn includes blockade standard deviation; simplified tab in code</span>
<span class="sd">				6/3/17		AB 	Updated docstring.</span>
<span class="sd">				8/24/15 	AB 	Rename algorithm to CUSUM+   </span>
<span class="sd">				3/20/15 	AB 	Added a new metadata column (mdStateResTime) that saves the residence time of each state to the database.</span>
<span class="sd">				3/18/15		KB	Implemented rise time skipping</span>
<span class="sd">				3/17/15		KB	Implemented adaptive threshold</span>
<span class="sd">				2/12/15		AB	Updated metadata representation to be consistent with stepResponseAnalysis and multiStateAnalysis</span>
<span class="sd">				2/10/15		KB	Initial version</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">mosaic.commonExceptions</span>
<span class="kn">import</span> <span class="nn">mosaic.process.metaEventProcessor</span> <span class="k">as</span> <span class="nn">metaEventProcessor</span>
<span class="kn">import</span> <span class="nn">mosaic.utilities.util</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">mosaic.utilities.mosaicLogging</span> <span class="k">as</span> <span class="nn">mlog</span>
<span class="kn">import</span> <span class="nn">mosaic.utilities.fit_funcs</span> <span class="k">as</span> <span class="nn">fit_funcs</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">fsolve</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cusumPlus&quot;</span><span class="p">,</span> <span class="s2">&quot;InvalidEvent&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="InvalidEvent"><a class="viewcode-back" href="../../../api-doc/mosaic.processing.html#mosaic.process.cusumPlus.InvalidEvent">[docs]</a><span class="k">class</span> <span class="nc">InvalidEvent</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
	<span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">datblock</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Smart data block that holds a time-series of data and keeps track</span>
<span class="sd">		of its mean and SD.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">sd</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>


<div class="viewcode-block" id="cusumPlus"><a class="viewcode-back" href="../../../api-doc/mosaic.processing.html#mosaic.process.cusumPlus.cusumPlus">[docs]</a><span class="k">class</span> <span class="nc">cusumPlus</span><span class="p">(</span><span class="n">metaEventProcessor</span><span class="o">.</span><span class="n">metaEventProcessor</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;	</span>
<span class="sd">		CUSUM+ will detect jumps that are smaller than `StepSize`, but they will have to be sustained longer. Threshold can be thought of, very roughly, as proportional to the length of time a subevent must be sustained for it to be detected. The algorithm will adjust the actual threshold used on a per-event basis in order to minimize false positive detection of current jumps This algorithm is based on code used in OpenNanopore, which you can read about here: http://pubs.rsc.org/en/Content/ArticleLanding/2012/NR/c2nr30951c#!divAbstract</span>


<span class="sd">				Some known issues with CUSUM+:</span>

<span class="sd">				1. If the duration of a sub-event is shorter than than the MinLength parameter, CUSUM+ will be unable to detect it. CUSUM+ will not detect events within MinLength of a previous event.</span>
<span class="sd">				2. CUSUM assumes an instantaneous transition between current states. As a result, if the RC rise time of the system is large, CUSUM+ can trigger and detect intermediate states during the change time. This can be avoided by choosing a number of samples to skip equal to about 2-5RC.</span>
<span class="sd">				3. As a consequence of using a statistical t-test, CUSUM can have false positives. The algorithm has an adaptive threshold that tries to minimize the chances of this happening while maintaining good sensitivity (expected number of false positives within an event is less than 1).</span>


<span class="sd">		:Keyword Args:</span>
<span class="sd">			In addition to :class:`~mosaic.metaEventProcessor.metaEventProcessor` args,</span>
<span class="sd">				- `StepSize` :			The number of baseline standard deviations are considered significant (3 is usually a good starting point).</span>
<span class="sd">				- `MinThreshold` :		One of two sensitivity parameters (lower is more sensitive). A good starting point is to set `MinThreshold` equal to `StepSize`.</span>
<span class="sd">				- `MaxThreshold` : 		One of two sensitivity parameters (lower is more sensitive). Set `MaxThreshold` about 3x higher than `MinThreshold`.</span>
<span class="sd">				- `MinLength` : 		The number of samples to skip after detecting a jump, in order to avoid triggering during the rise time and returning an artificially high number of states. This number of points is also skipped when averaging levels. About 4 times the RC constant of the system is a good starting value.</span>

<span class="sd">		:Errors:</span>
<span class="sd">			When an event cannot be analyzed, all metadata are set to -1.</span>

<span class="sd">		To use it requires four settings:</span>


<span class="sd">		.. code-block:: javascript</span>

<span class="sd">			&quot;cusumPlus&quot;: {</span>
<span class="sd">				&quot;StepSize&quot;: 3.0, </span>
<span class="sd">				&quot;MinThreshold&quot;: 3.0,</span>
<span class="sd">				&quot;MaxThreshold&quot;: 10.0,</span>
<span class="sd">				&quot;MinLength&quot; : 10,</span>
<span class="sd">			}</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Initialize the single step analysis class.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># initialize the object&#39;s metadata (to -1) as class attributes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span><span class="o">=-</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mdCurrentStep</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdNStates</span><span class="o">=-</span><span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockDepth</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockSTD</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mdStateResTime</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdEventStart</span><span class="o">=-</span><span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mdEventEnd</span><span class="o">=-</span><span class="mi">1</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">mdResTime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdAbsEventStart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdThreshold</span><span class="o">=-</span><span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="o">=-</span><span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">=</span><span class="n">mlog</span><span class="o">.</span><span class="n">mosaicLogging</span><span class="p">()</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

		<span class="c1"># Settings for detection of changed in current level</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;StepSize&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;MinThreshold&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;MaxThreshold&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;MinLength&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">commonExceptions</span><span class="o">.</span><span class="n">SettingsTypeError</span><span class="p">(</span> <span class="n">err</span> <span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">mdThreshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span>

	<span class="c1">###########################################################################</span>
	<span class="c1"># Interface functions implemented starting here</span>
	<span class="c1">###########################################################################</span>
	<span class="k">def</span> <span class="nf">_processEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			This function implements the core logic to analyze one single step-event.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1"># Run CUSUM+ to detect changes in level</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__FitEvent</span><span class="p">()</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">raise</span>

	<span class="k">def</span> <span class="nf">_mdList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Return a list of meta-data from the analysis of single step events. We explicitly</span>
<span class="sd">			control the order of the data to keep formatting consistent. 				</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">[</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdProcessingStatus</span><span class="p">,</span> 
					<span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdNStates</span><span class="p">,</span> 
					<span class="bp">self</span><span class="o">.</span><span class="n">mdCurrentStep</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockDepth</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockSTD</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdEventStart</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdEventEnd</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdStateResTime</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdResTime</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdAbsEventStart</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">mdThreshold</span>
				<span class="p">]</span>
		
	<span class="k">def</span> <span class="nf">_mdHeadingDataType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Return a list of meta-data tags data types.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">[</span>
					<span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;REAL&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL_LIST&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL_LIST&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL_LIST&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL_LIST&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL_LIST&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
					<span class="s1">&#39;REAL&#39;</span>
				<span class="p">]</span>

	<span class="k">def</span> <span class="nf">_mdHeadings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Explicity set the metadata to print out.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="p">[</span>
					<span class="s1">&#39;ProcessingStatus&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;OpenChCurrent&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;NStates&#39;</span><span class="p">,</span>
					<span class="s1">&#39;CurrentStep&#39;</span><span class="p">,</span>
					<span class="s1">&#39;BlockDepth&#39;</span><span class="p">,</span>
					<span class="s1">&#39;BlockSTD&#39;</span><span class="p">,</span>
					<span class="s1">&#39;EventStart&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;EventEnd&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;EventDelay&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;StateResTime&#39;</span><span class="p">,</span>
					<span class="s1">&#39;ResTime&#39;</span><span class="p">,</span> 
					<span class="s1">&#39;AbsEventStart&#39;</span><span class="p">,</span>
					<span class="s1">&#39;Threshold&#39;</span>
				<span class="p">]</span>

<div class="viewcode-block" id="cusumPlus.mdAveragePropertiesList"><a class="viewcode-back" href="../../../api-doc/mosaic.processing.html#mosaic.process.cusumPlus.cusumPlus.mdAveragePropertiesList">[docs]</a>	<span class="k">def</span> <span class="nf">mdAveragePropertiesList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Return a list of meta-data properties that will be averaged </span>
<span class="sd">			and displayed at the end of a run. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">pass</span></div>

<div class="viewcode-block" id="cusumPlus.formatsettings"><a class="viewcode-back" href="../../../api-doc/mosaic.processing.html#mosaic.process.cusumPlus.cusumPlus.formatsettings">[docs]</a>	<span class="k">def</span> <span class="nf">formatsettings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Return a formatted string of settings for display</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Event processing settings:&#39;</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Algorithm = CUSUM+&#39;</span> <span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Jump Size  = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="p">)</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Min. State Length  = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="p">)</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Min. Threshold  = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span><span class="p">)</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cusumLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Max. Threshold  = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="p">)</span> <span class="p">)</span></div>


	<span class="c1">###########################################################################</span>
	<span class="c1"># Local functions</span>
	<span class="c1">###########################################################################</span>
	<span class="k">def</span> <span class="nf">_GetThreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ARL</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mun</span><span class="p">):</span>
		<span class="n">ARL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ARL</span> <span class="c1">#double since we are doing two-sided CUSUM</span>
		<span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">sigma</span><span class="o">+</span><span class="mf">1.166</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">sigma</span><span class="o">+</span><span class="mf">1.166</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="n">mun</span><span class="p">)</span><span class="o">-</span><span class="n">ARL</span>

		<span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if a root exists in the specified range</span>
			<span class="n">opth</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ier</span><span class="p">,</span> <span class="n">mesg</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">ier</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#fit success, return the root</span>
			        <span class="n">Threshold</span> <span class="o">=</span> <span class="n">opth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1">#fit failure, default to min</span>
				<span class="n">Threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1">#if no root exists, we use the min value</span>
			<span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">sigma</span><span class="o">+</span><span class="mf">1.166</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">sigma</span><span class="o">+</span><span class="mf">1.166</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">mun</span><span class="o">*</span><span class="n">mun</span><span class="p">)</span><span class="o">-</span><span class="n">ARL</span><span class="p">)</span> <span class="c1">#absolute value to minimize</span>
			<span class="n">opth</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">MaxThreshold</span><span class="p">),))</span> <span class="c1">#Find the min within the requested range</span>
			<span class="k">if</span> <span class="n">opth</span><span class="o">.</span><span class="n">success</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
			        <span class="n">Threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MinThreshold</span> <span class="c1">#Default to more sensitive</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Threshold</span> <span class="o">=</span> <span class="n">opth</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">Threshold</span>

	<span class="k">def</span> <span class="nf">__FitEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">dt</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Fs</span> 	<span class="c1"># time-step in ms.</span>
			<span class="n">edat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataPolarity</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventData</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span> <span class="p">)</span> <span class="c1">#make data into an array and make it abs val</span>

			<span class="n">Threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetThreshold</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

			<span class="c1"># control numpy error reporting</span>
			<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

						<span class="c1">#set up variables for the main CUSUM+ loop</span>
			
			<span class="n">logp</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#instantaneous log-likelihood for positive jumps</span>
			<span class="n">logn</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#instantaneous log-likelihood for negative jumps</span>
			<span class="n">cpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="c1">#cumulative log-likelihood function for positive jumps</span>
			<span class="n">cneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="c1">#cumulative log-likelihood function for negative jumps</span>
			<span class="n">gpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="c1">#decision function for positive jumps</span>
			<span class="n">gneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="c1">#decision function for negative jumps</span>
			<span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span> <span class="c1">#initialize an array with the position of the first subevent - the start of the event</span>
			<span class="n">anchor</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#the last detected change</span>
			<span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">)</span>
			<span class="n">mean</span> <span class="o">=</span> <span class="n">edat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">varM</span> <span class="o">=</span> <span class="n">edat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">varS</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">mean</span> <span class="o">=</span> <span class="n">edat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
				<span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">varOldM</span> <span class="o">=</span> <span class="n">varM</span> <span class="c1">#algorithm to calculate running variance, details here: http://www.johndcook.com/blog/standard_deviation/</span>
				<span class="n">varM</span> <span class="o">=</span> <span class="n">varM</span> <span class="o">+</span> <span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">varM</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">anchor</span><span class="p">)</span>
				<span class="n">varS</span> <span class="o">=</span> <span class="n">varS</span> <span class="o">+</span> <span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">varOldM</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">varM</span><span class="p">)</span>
				<span class="n">variance</span> <span class="o">=</span> <span class="n">varS</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">anchor</span><span class="p">)</span>
				<span class="n">mean</span> <span class="o">=</span> <span class="p">((</span><span class="n">k</span><span class="o">-</span><span class="n">anchor</span><span class="p">)</span> <span class="o">*</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">anchor</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">variance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>                 <span class="c1"># with low-precision data sets it is possible that two adjacent values are equal, in which case there is zero variance for the two-vector of sample if this occurs next to a detected jump. This is very, very rare, but it does happen.</span>
					<span class="n">variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span> <span class="c1"># in that case, we default to the local baseline variance, which is a good an estimate as any.</span>
				<span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">/</span><span class="n">variance</span> <span class="o">*</span> <span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="c1">#instantaneous log-likelihood for current sample assuming local baseline has jumped in the positive direction</span>
				<span class="n">logn</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">/</span><span class="n">variance</span> <span class="o">*</span> <span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="c1">#instantaneous log-likelihood for current sample assuming local baseline has jumped in the negative direction</span>
				<span class="n">cpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpos</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logp</span> <span class="c1">#accumulate positive log-likelihoods</span>
				<span class="n">cneg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cneg</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logn</span> <span class="c1">#accumulate negative log-likelihoods</span>
				<span class="n">gpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gpos</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#accumulate or reset positive decision function </span>
				<span class="n">gneg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gneg</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#accumulate or reset negative decision function</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Threshold</span> <span class="ow">or</span> <span class="n">gneg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Threshold</span><span class="p">):</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">gpos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Threshold</span><span class="p">):</span> <span class="c1">#significant positive jump detected</span>
						<span class="n">jump</span> <span class="o">=</span> <span class="n">anchor</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">cpos</span><span class="p">[</span><span class="n">anchor</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#find the location of the start of the jump</span>
						<span class="k">if</span> <span class="n">jump</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="p">:</span>
							<span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">jump</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">gneg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Threshold</span><span class="p">):</span> <span class="c1">#significant negative jump detected</span>
						<span class="n">jump</span> <span class="o">=</span> <span class="n">anchor</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">cneg</span><span class="p">[</span><span class="n">anchor</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
						<span class="k">if</span> <span class="n">jump</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="p">:</span>
							<span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">jump</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">anchor</span> <span class="o">=</span> <span class="n">k</span>
					<span class="n">cpos</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">cpos</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#reset all decision arrays</span>
					<span class="n">cneg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">cneg</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">gpos</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">gpos</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">gneg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">gneg</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">mean</span> <span class="o">=</span> <span class="n">edat</span><span class="p">[</span><span class="n">anchor</span><span class="p">]</span>
					<span class="n">varM</span> <span class="o">=</span> <span class="n">edat</span><span class="p">[</span><span class="n">anchor</span><span class="p">]</span>
			<span class="n">varS</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edat</span><span class="p">))</span> <span class="c1">#mark the end of the event as an edge</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">cusum</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eInvalidStates&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">minstepflag</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">while</span> <span class="n">minstepflag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">minstepflag</span> <span class="o">=</span> <span class="mi">1</span>
					<span class="n">currentlevels</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="p">)]</span> <span class="c1">#detect current levels during detected sub-events</span>

					<span class="n">currentSTD</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">edat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">MinLength</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="p">)]</span>

					<span class="n">toosmall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">currentlevels</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">StepSize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseSD</span><span class="o">/</span><span class="mi">2</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">toosmall</span><span class="p">)):</span>
						<span class="k">if</span> <span class="n">toosmall</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
							<span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
							<span class="n">minstepflag</span> <span class="o">=</span> <span class="mi">0</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">-=</span> <span class="mi">1</span>
							<span class="k">break</span>
			<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eInvalidStates&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentLevels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentlevels</span>
				<span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentSTD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentSTD</span>
				<span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;EventDelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span> <span class="o">*</span> <span class="n">dt</span> <span class="c1">#locations of sub-events in the data</span>
				<span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Threshold</span> <span class="c1">#record the threshold used</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__recordevent</span><span class="p">(</span><span class="n">cusum</span><span class="p">)</span>

		<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eFitUserStop&#39;</span><span class="p">)</span>
			<span class="k">raise</span>
		<span class="k">except</span> <span class="n">InvalidEvent</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eInvalidEvent&#39;</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eUnknownError&#39;</span><span class="p">)</span>


	<span class="k">def</span> <span class="nf">__recordevent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cusum</span><span class="p">):</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Fs</span> 	<span class="c1"># time-step in ms.</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eInvalidStates&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span> 	<span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentLevels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentLevels&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">nStates</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#this assumes that the event returns to baseline after</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mdCurrentStep</span>		<span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span><span class="p">],</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentLevels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])))</span> <span class="c1">#these current levels are relative to the open state</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">mdNStates</span>			<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nStates</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">#this does not count padding as separate states. Note also that states can be triggered inside the padding</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockDepth</span> 		<span class="o">=</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentLevels&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span> <span class="c1">#percentage blockage of each state</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdBlockSTD</span>			<span class="o">=</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;CurrentSTD&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span>		<span class="o">=</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;EventDelay&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># first and last states (or baseline) are removed</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdStateResTime</span> 	<span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdEventStart</span>		<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#the first nonzero event</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mdEventEnd</span>			<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdEventDelay</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#the last non zero event, this assumes no events triggered in the padding</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdResTime</span>			<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdEventEnd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdEventStart</span> 

			<span class="bp">self</span><span class="o">.</span><span class="n">mdAbsEventStart</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdEventStart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">absDataStartIndex</span> <span class="o">*</span> <span class="n">dt</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">mdThreshold</span> 		<span class="o">=</span> <span class="n">cusum</span><span class="p">[</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>


			<span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span><span class="p">):</span>
				<span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdOpenChCurrent</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rejectEvent</span><span class="p">(</span><span class="s1">&#39;eInvalidOpenChCurr&#39;</span><span class="p">)</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<!-- 
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.<br/>
    </p>
  </div>
</footer> -->
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<div class="footer" style="vertical-align: center" align="center">
		<table width="90%" style="vertical-align: center">
			<col width=40%>
			<col width=60%>
			<tr>
				<td align="left">
					<a href="../../../doc/Developers.html"><small><em>MOSAIC Developers</em></small></a> |
					<a href="http://www.nist.gov/pml/div683/grp06/abalijepalli.cfm"><small><em>Contact</em></small></a> |
					<a href="../../../doc/Disclaimer.html"><small><em>Terms of Use</em></small></a>
				</td>
			<!-- </tr>
			<tr> -->
				<td align="right">
					<a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy"><small>Privacy Policy</small></a> |
					<a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot"><small>Security Notice</small></a> |
					<a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate"><small>Accessibility Statement</small></a> |
					<a target="_blank" href="mailto:data@nist.gov?subject=Feedback%20on%20Web%20Site%20Template"><small>Send feedback</small></a>
					<br/>
				</td>
			</tr>
		</table>

		<br />
		<a href="http://www.nist.gov/"><small><em>National Institute of Standards and Technology</em></small></a>
		<!-- <a href="http://www.nist.gov"><img src="_static/nist_logo.png" width="30%" alt="National Institute of Standards and Technology"></a> -->

</div>

  </body>
</html>